# Репликация
## Создаем сетевую инфраструктуру и VM1:
```
yc vpc network create --name net-otus1 --description "net-otus1" && \
yc vpc subnet create --name subnet-otus1 --range 192.168.0.0/24 --network-name net-otus1 --description "subnet-otus1" && \
yc compute instance create --name 1 --hostname vm-otus1 --cores 2 --memory 4 --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts --network-interface subnet-name=subnet-otus1,nat-ip-version=ipv4 --ssh-key ~/.ssh/id_rsa.pub 
yc compute instance create --name vm-otus2 --hostname vm-otus2 --cores 2 --memory 4 --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts --network-interface subnet-name=subnet-otus1,nat-ip-version=ipv4 --ssh-key ~/.ssh/id_rsa.pub 
yc compute instance create --name vm-otus3 --hostname vm-otus3 --cores 2 --memory 4 --create-boot-disk size=15G,type=network-hdd,image-folder-id=standard-images,image-family=ubuntu-2404-lts --network-interface subnet-name=subnet-otus1,nat-ip-version=ipv4 --ssh-key ~/.ssh/id_rsa.pub
```

 список ВМ
```
yc compute instances list
```

Подключимся к VM:
```
vm_ip_address1=$(yc compute instance show --name vm-otus1 | grep -E ' +address' | tail -n 1 | awk '{print $2}') && ssh -o StrictHostKeyChecking=no yc-user@$vm_ip_address1
vm_ip_address2=$(yc compute instance show --name vm-otus2 | grep -E ' +address' | tail -n 1 | awk '{print $2}') && ssh -o StrictHostKeyChecking=no yc-user@$vm_ip_address2
vm_ip_address3=$(yc compute instance show --name vm-otus3 | grep -E ' +address' | tail -n 1 | awk '{print $2}') && ssh -o StrictHostKeyChecking=no yc-user@$vm_ip_address3
```
## На всех VM

Установим PostgreSQL на всех VM:
```
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt -y install postgresql && sudo apt install unzip && sudo apt -y install mc
```
Проверка состояния
```
pg_lsclusters
systemctl status postgresql@18-main.service
```

## На VM1 (master)
### Подготовка конфигурации для репликации
Параметры /etc/postgresql/18/main/postgresql.conf
```
listen_addresses = '*'  
wal_level = replica  
wal_log_hints = on  
work_mem = 32MB
```
```
sudo cp /etc/postgresql/18/main/postgresql.conf  /etc/postgresql/18/main/postgresql.conf.$(date +%F).bak 

sudo sed -i "/^#listen_addresses/s/.*/listen_addresses = '*'/" /etc/postgresql/18/main/postgresql.conf
sudo sed -i "/^#wal_level/s/.*/wal_level = replica/" /etc/postgresql/18/main/postgresql.conf
sudo sed -i "/^#wal_log_hints/s/.*/wal_log_hints = on/" /etc/postgresql/18/main/postgresql.conf
sudo sed -i "/^#work_mem/s/.*/work_mem = 32MB/" /etc/postgresql/18/main/postgresql.conf
```

### Параметры /etc/postgresql/18/main/pg_hba.conf
```
host    all             all             192.168.0.0/24               scram-sha-256
host	  replication		имя_пользователя	0.0.0.0/0		scram-sha-256
```
```
sudo cp /etc/postgresql/18/main/pg_hba.conf  /etc/postgresql/18/main/pg_hba.conf.$(date +%F).bak 

echo "host    all             all             192.168.0.0/24               scram-sha-256" | sudo tee -a /etc/postgresql/18/main/pg_hba.conf
```
Применение конфигурации 
```
sudo pg_ctlcluster 18 main restart
```
Устанавливаем пароль пользователю `postgres`
```
export PGPASSWORD=postgres
sudo -u postgres psql -c "alter user postgres password '${PGPASSWORD}';"
echo "localhost:5432:*:postgres:${PGPASSWORD}" > .pgpass
`chmod 0600 ~/.pgpass`
```

переход в постгрес
```
psql -h localhost -U postgres
```

```
create database otus;
\c otus

create table student as
select generate_series(1,10) as id,
md5(random()::text)::char(10) as fio;


select * from student;

show wal_level;
```

## На VM2 (replica)
### Подготовка конфигурации для репликации
Параметры /etc/postgresql/18/main/postgresql.conf
```
listen_addresses = '*'  
wal_level = logical 
```
```
sudo cp /etc/postgresql/18/main/postgresql.conf  /etc/postgresql/18/main/postgresql.conf.$(date +%F).bak 

sudo sed -i "/^#listen_addresses/s/.*/listen_addresses = '*'/" /etc/postgresql/18/main/postgresql.conf
sudo sed -i "/^#wal_level/s/.*/wal_level = logical/" /etc/postgresql/18/main/postgresql.conf
```
Применение конфигурации
```
sudo pg_ctlcluster 18 main restart
```

### На VM2 удалим файлы

```
sudo pg_ctlcluster 18 main stop

sudo rm -rf /var/lib/postgresql/18/main
```
Сделаем бэкап нашей БД. Ключ -R создаст заготовку управляющего файла recovery.conf.
`
VM_OTUS1_IP=$(nslookup vm-otus1 |  grep Addres | tail -n +2 | awk '{print $2}')
echo "${VM_OTUS1_IP}:5432:*:postgres:postgres" >> .pgpass
chmod 0600 .pgpass
sudo cp .pgpass /var/lib/postgresql/
sudo chown postgres:postgres /var/lib/postgresql/.pgpass
sudo -u postgres pg_basebackup -D /var/lib/postgresql/18/main -R -X stream -C -S replica02 -v -h ${VM_OTUS1_IP} -w  
`

(Удалить слот репликации на vm-otus1
```
sudo -u postgres psql -c "SELECT slot_name, slot_type, active, active_pid, restart_lsn FROM pg_replication_slots;"
sudo -u postgres psql -c "SELECT * FROM pg_replication_slots;"
```
)

посмотрим
```
cat /var/lib/postgresql/18/main/postgresql.auto.conf
```
удалим лог файл
```
sudo rm  /var/log/postgresql/postgresql-18-main.log
```
Стартуем кластер
```
sudo pg_ctlcluster 18 main start
```
Смотрим как стартовал
pg_lsclusters


sudo -u postgres psql -d otus

Проверим состояние репликации:
на мастере
SELECT * FROM pg_stat_replication \gx
SELECT * FROM pg_current_wal_lsn();
select * from pg_replication_slots;

на реплике
select * from pg_stat_wal_receiver \gx
select pg_last_wal_receive_lsn();
select pg_last_wal_replay_lsn();

Перевод в состояние мастера
sudo pg_ctlcluster 18 main promote
или
select pg_promote();

SELECT * FROM pg_stat_replication \gx



дока по pg_rewind https://postgrespro.ru/docs/postgresql/18/app-pgrewind


--------Логическая репликация
# 2VM
show wal_level;
--ALTER SYSTEM SET wal_level = logical;

создать пользователя
create user repl1 replication password '2222';

выдать права на таблицу student
GRANT select ON TABLE student TO repl1;

создаем публикацию:
CREATE PUBLICATION test_pub FOR TABLE student;

Просмотр созданной публикации
\dRp+



# 3VM
sudo -u postgres psql
create database otus;
\c otus
create table student(id integer, fio char(10));


создадим подписку 
--создадим подписку к БД по Порту с Юзером и Паролем и Копированием данных=true
CREATE SUBSCRIPTION otus_sub 
CONNECTION 'host=178.154.229.124 port=5432 user=repl1 password=2222 dbname=otus' 
PUBLICATION test_pub WITH (copy_data = true);

\dRs
SELECT * FROM pg_stat_subscription \gx


--добавим одинаковые данные
---добавить индекс
create unique index on student(id);
\dS+ student

добавить одиноковые значения
удалить на втором экземпляре конфликтные записи

SELECT * FROM pg_stat_subscription \gx	просмотр состояния (при конфликте пусто)

просмотр логов
$ tail -n 10 /var/log/postgresql/postgresql-18-main.log

drop subscription otus_sub;
drop publication test_pub;


------------- !!! подписка на одну и ту же таблицу

create table oscar(id int, year int, age int, name varchar(20), movie varchar(50));

у обоих серверов 
ALTER SYSTEM SET wal_level = logical;

Рестартуем кластера
sudo pg_ctlcluster 16 main restart
sudo pg_ctlcluster 16 main2 restart

sudo -u postgres psql -p 5434 -d otus
sudo -u postgres psql -p 5435 -d otus

Задать пароль
\password 
pas16-1
pas16-2

На первом сервере создаем публикацию:
CREATE PUBLICATION pub_1 FOR TABLE oscar;


На втором сервере создаем публикацию:
CREATE PUBLICATION pub_2 FOR TABLE oscar;

Просмотр созданной публикации
\dRp+

создадим подписку на втором экземпляре
CREATE SUBSCRIPTION sub_1 
CONNECTION 'host=localhost port=5434 user=postgres password=pas16-1 dbname=otus' 
PUBLICATION pub_1 WITH (copy_data = false, origin=none);

создадим подписку на первом экземпляре
CREATE SUBSCRIPTION sub_2 
CONNECTION 'host=localhost port=5435 user=postgres password=pas16-2 dbname=otus' 
PUBLICATION pub_2 WITH (copy_data = false, origin=none);

\dRs

insert into oscar(id, year, age, name, movie) values(100, 2024, 30, 'NoName', 'Film1');

drop subscription sub_1;
drop subscription sub_2;
drop publication pub_1;
drop publication pub_2;




-------- создание побликации на все таблицы
create publication test_pub for all tables;

create table students12 as select generate_series(1, 10) as id, md5(random()::text)::char(10) as fio; 
create table if not exists students12 (id int, fio char(10));

create subscription test_sub
connection 'host=localhost port=5432 user=postgres password=postgres dbname=otus'
publication test_pub with (copy_data = true);



---------- Удаление подписки на реплике при отсутствующем слоте
ALTER SUBSCRIPTION testt_sub DISABLE;
ALTER SUBSCRIPTION testt_sub SET (slot_name=NONE);
DROP SUBSCRIPTION testt_sub;


# удаление VM
yc compute instance delete vm-otus3

yc compute instance delete vm-otus2

yc compute instance delete vm-otus1 && yc vpc subnet delete subnet-otus1 && yc vpc network delete net-otus1
