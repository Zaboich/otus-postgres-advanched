# Логическая репликация
# 2VM
show wal_level;
--ALTER SYSTEM SET wal_level = logical;

создать пользователя
create user repl1 replication password '2222';

выдать права на таблицу student
GRANT select ON TABLE student TO repl1;

создаем публикацию:
CREATE PUBLICATION test_pub FOR TABLE student;

Просмотр созданной публикации
\dRp+



# 3VM
sudo -u postgres psql
create database otus;
\c otus
create table student(id integer, fio char(10));


создадим подписку 
--создадим подписку к БД по Порту с Юзером и Паролем и Копированием данных=true
CREATE SUBSCRIPTION otus_sub 
CONNECTION 'host=178.154.229.124 port=5432 user=repl1 password=2222 dbname=otus' 
PUBLICATION test_pub WITH (copy_data = true);

\dRs
SELECT * FROM pg_stat_subscription \gx


--добавим одинаковые данные
---добавить индекс
create unique index on student(id);
\dS+ student

добавить одиноковые значения
удалить на втором экземпляре конфликтные записи

SELECT * FROM pg_stat_subscription \gx	просмотр состояния (при конфликте пусто)

просмотр логов
$ tail -n 10 /var/log/postgresql/postgresql-18-main.log

drop subscription otus_sub;
drop publication test_pub;


------------- !!! подписка на одну и ту же таблицу

create table oscar(id int, year int, age int, name varchar(20), movie varchar(50));

у обоих серверов 
ALTER SYSTEM SET wal_level = logical;

Рестартуем кластера
sudo pg_ctlcluster 16 main restart
sudo pg_ctlcluster 16 main2 restart

sudo -u postgres psql -p 5434 -d otus
sudo -u postgres psql -p 5435 -d otus

Задать пароль
\password 
pas16-1
pas16-2

На первом сервере создаем публикацию:
CREATE PUBLICATION pub_1 FOR TABLE oscar;


На втором сервере создаем публикацию:
CREATE PUBLICATION pub_2 FOR TABLE oscar;

Просмотр созданной публикации
\dRp+

создадим подписку на втором экземпляре
CREATE SUBSCRIPTION sub_1 
CONNECTION 'host=localhost port=5434 user=postgres password=pas16-1 dbname=otus' 
PUBLICATION pub_1 WITH (copy_data = false, origin=none);

создадим подписку на первом экземпляре
CREATE SUBSCRIPTION sub_2 
CONNECTION 'host=localhost port=5435 user=postgres password=pas16-2 dbname=otus' 
PUBLICATION pub_2 WITH (copy_data = false, origin=none);

\dRs

insert into oscar(id, year, age, name, movie) values(100, 2024, 30, 'NoName', 'Film1');

drop subscription sub_1;
drop subscription sub_2;
drop publication pub_1;
drop publication pub_2;




-------- создание побликации на все таблицы
create publication test_pub for all tables;

create table students12 as select generate_series(1, 10) as id, md5(random()::text)::char(10) as fio; 
create table if not exists students12 (id int, fio char(10));

create subscription test_sub
connection 'host=localhost port=5432 user=postgres password=postgres dbname=otus'
publication test_pub with (copy_data = true);



---------- Удаление подписки на реплике при отсутствующем слоте
ALTER SUBSCRIPTION testt_sub DISABLE;
ALTER SUBSCRIPTION testt_sub SET (slot_name=NONE);
DROP SUBSCRIPTION testt_sub;


# удаление VM
yc compute instance delete vm-otus3

yc compute instance delete vm-otus2

yc compute instance delete vm-otus1 && yc vpc subnet delete subnet-otus1 && yc vpc network delete net-otus1
